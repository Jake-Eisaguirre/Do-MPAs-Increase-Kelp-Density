---
title: "Untitled"
author: "Jake Eisaguirre"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(patchwork)
library(broom)
library(dynlm)
library(dyn)
library(modelr)
library(car)
library(ggpubr)
library(rstatix)
```

#read in and clean data
```{r}

raw_data <- read_csv(here("MLPA_swath_site_means.csv"))


annual_mean <- raw_data %>% 
  separate(col = site, into = c('island', 'site'), sep = '_') %>% 
  filter(island %in% c("ANACAPA", "SCI", "SRI", "SMI")) %>% 
  filter(campus == "UCSB") %>% 
  select(c("survey_year", "site", "island", "latitude", "longitude", "site_status", 
           "den_STRPURAD", "den_MESFRAAD", "den_MACPYRAD", "den_MACSTIPES")) %>% 
  group_by(survey_year, site_status) %>% 
  mutate(mean_purp = mean(den_STRPURAD),
            mean_red = mean(den_MESFRAAD),
         mean_stipe = mean(den_MACSTIPES),
         mean_mac = mean(den_MACPYRAD)) %>% 
  ungroup()
  
  

```

```{r}

a <- ggplot(data = annual_mean) +
  geom_line(aes(x = survey_year, y = mean_purp, color = site_status)) +
  theme_classic() +
  xlab("Year")+
  ylab("Mean Purple Urchins")

b <- ggplot(data = annual_mean) +
  geom_line(aes(x = survey_year, y = mean_red, color = site_status)) +
  theme_classic()+
  xlab("Year")+
  ylab("Mean Red Urchins")

c <- ggplot(data = annual_mean) +
  geom_line(aes(x = survey_year, y = mean_stipe, color = site_status)) +
  theme_classic()+
  xlab("Year")+
  ylab("Mean Kelp")


a/c



```

```{r}


k <- lm(den_MACSTIPES ~ den_STRPURAD + site_status + site_status:den_STRPURAD, 
        data = annual_mean)
summary(k)



annual_mean %>% 
  ggplot(aes(x = den_STRPURAD, y = den_MACSTIPES, color = site_status)) +
  geom_point(alpha = 0.5, aes(color =site_status)) +
  geom_smooth(formula = y ~ x, method = "lm", se = F, lwd = 0.8) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 600), expand = c(0.01,0.01)) +
  scale_x_continuous(limits = c(0, 3000), expand = c(0.01,0.01)) +
  ylab("Kelp Density") +
  xlab("Urchin Density") +
  labs(color = "Site Status")







```
```{r}
aug <- annual_mean %>% 
  add_predictions(k) %>% 
  mutate(residuals = den_MACSTIPES - pred)

ggplot(data = aug) +
  geom_histogram(aes(residuals), binwidth = 25) +
  theme_classic()

qqPlot(aug$residuals) 

mean(aug$residuals)

ggplot(data = aug) +
  geom_point(aes(y = residuals, x = den_STRPURAD)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_classic()



```

```{r}
#null: no difference of kelp and urchins across reference sites and mpas
#alternative: there is a difference

kelp.test <-t.test(den_MACSTIPES ~ site_status, data = annual_mean)
kelp.test

kelp_bxp <-ggboxplot(annual_mean, x = "site_status", y = "den_MACSTIPES",
                     xlab = "Site Status", ylab = "Kelp Density", 
                     title = "T Test, t(763.74) = 2.5502, p < 0.05 (p = 0.011), n = 864",
                     bxp.errorbar = T,
                     alpha = 0.3, 
                     color = c("blue", "red"))




urch <- t.test(den_STRPURAD ~ site_status , data = annual_mean)
urch

urch_bxp <-ggboxplot(annual_mean, x = "site_status", y = "den_STRPURAD",
                     xlab = "Site Status", ylab = "Urchin Density", 
                     title = "T Test, t(822) = -2.2465, p < 0.05 (p = 0.0249), n = 864",
                     bxp.errorbar = T,
                     alpha = 0.3, 
                     color = c("blue", "red"))



```
```{r}


time_lag_mpa <- annual_mean %>% 
  filter(site_status == "mpa",
         survey_year >2002) %>% 
  ts()

time_lag_ref <- annual_mean %>% 
  filter(site_status == "reference",
         survey_year >2002) %>% 
  ts()


dfm1_mpa <- dynlm(den_STRPURAD ~ L(den_STRPURAD, 1:18), data = time_lag_mpa)

dfm1_ref <- dynlm(den_STRPURAD ~ L(den_STRPURAD, 1:18), data = time_lag_ref)



df_1_mpa <- cbind(dfm1_mpa$coefficients[2:18]) %>% 
  as.data.frame() %>% 
  rename(lag_coefficient = V1) %>% 
  add_column(t_mpa= 1:17)

df_1_ref <- cbind(dfm1_ref$coefficients[2:18]) %>% 
  as.data.frame() %>% 
  rename(lag_coefficient = V1) %>% 
  add_column(t_mpa= 1:17)

df_1_sci <- cbind(dfm1_sci$coefficients[2:18]) %>% 
  as.data.frame() %>% 
  rename(lag_coefficient = V1) %>% 
  add_column(t_mpa= 1:17)
  


ggplot() +
  geom_line(aes(y = lag_coefficient, x = t_mpa), data = df_1_mpa, color = "red") +
  theme_classic() +
  ylab("Mean Urchin Density Coefficients") +
  xlab("Time Since MPA Implementation") +
  geom_line(aes(y = lag_coefficient, x = t_mpa), data = df_1_ref, color = "blue" ) +
  geom_hline(yintercept = 0, linetype = "dashed")
  
  

```

```{r}
dfm2_mpa <- dynlm(den_MACSTIPES ~ L(den_MACSTIPES, 1:18), data = time_lag_mpa)

dfm2_ref <- dynlm(den_MACSTIPES ~ L(den_MACSTIPES, 1:18), data = time_lag_ref)


df_2_mpa <- cbind(dfm2_mpa$coefficients[2:18]) %>% 
  as.data.frame() %>% 
  rename(lag_coefficient = V1) %>% 
  add_column(t_mpa= 1:17)

df_2_ref <- cbind(dfm2_ref$coefficients[2:18]) %>% 
  as.data.frame() %>% 
  rename(lag_coefficient = V1) %>% 
  add_column(t_mpa= 1:17)
  

ggplot() +
  geom_line(aes(y = lag_coefficient, x = t_mpa), data = df_2_mpa, color = "red") +
  theme_classic() +
  geom_line(aes(y = lag_coefficient, x = t_mpa), data = df_2_ref, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed")+
  ylab("Mean Kelp Density Coefficients") +
  xlab("Time Since MPA Implementation")



```

